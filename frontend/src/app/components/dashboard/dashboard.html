<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Lecturer Dashboard - Energy Game Control</h1>
    <button class="logout-btn" (click)="logout()">Logout</button>
  </div>

  <div *ngIf="isLoading" class="loading">
    <p>Loading...</p>
  </div>

  <div *ngIf="!isLoading && userInfo" class="dashboard-content">
    <div class="welcome-card">
      <h2>Welcome, {{ userInfo.name || 'Lecturer' }}!</h2>
      <p><strong>Group:</strong> {{ userInfo.group_id || 'group1' }}</p>
      <p><strong>Department:</strong> {{ userInfo.metadata?.department || 'Unknown' }}</p>
      <p><strong>User Type:</strong> {{ userInfo.user_type }}</p>
    </div>

    <!-- Lecturer-only sections -->
    <div *ngIf="userInfo.user_type === 'lecturer'">
      <!-- Scenario Selection Section -->
      <div class="scenario-section">
        <div class="content-card">
          <h3>üìã Scenario Selection</h3>
          
          <div *ngIf="scenarios.length > 0" class="scenario-controls">
            <div class="form-group">
              <label for="scenario-select">Choose Scenario:</label>
              <select id="scenario-select" [(ngModel)]="selectedScenario" class="scenario-select">
                <option *ngFor="let scenario of scenarios" [value]="scenario.id">
                  {{ scenario.name }}
                </option>
              </select>
            </div>
          </div>

          <div *ngIf="scenarios.length === 0" class="no-scenarios">
            <p>No scenarios available.</p>
          </div>
        </div>
      </div>

      <!-- Game Control Section -->
      <div class="game-control-section">
        <div class="content-card">
          <h3>üéÆ Game Control</h3>

          <div *ngIf="gameStatus" class="game-status">
            <div class="status-header">
              <h4>Game Status - {{ userInfo.group_id || 'group1' }}</h4>
              <div class="status-badges">
                <span class="badge" [class.active]="gameStatus.game_active" [class.inactive]="!gameStatus.game_active">
                  {{ gameStatus.game_active ? 'Game Active' : 'Game Inactive' }}
                </span>
                <span class="badge scenario-name" *ngIf="gameStatus.scenario">
                  {{ gameStatus.scenario }}
                </span>
              </div>
            </div>

            <div class="game-info">
              <p><strong>Current Round:</strong> {{ gameStatus.current_round }} / {{ gameStatus.total_rounds }}</p>
              <p><strong>Registered Boards:</strong> {{ gameStatus.statistics?.length || 0 }}</p>
            </div>

            <div class="game-controls">
              <button *ngIf="!gameStatus.game_active" class="btn btn-start" (click)="startGame()"
                [disabled]="isGameLoading || !selectedScenario">
                {{ isGameLoading ? 'Starting...' : 'Start Game' }}
              </button>

              <button *ngIf="gameStatus.game_active && gameStatus.current_round < gameStatus.total_rounds"
                class="btn btn-next" (click)="nextRound()" [disabled]="isGameLoading">
                {{ isGameLoading ? 'Processing...' : 'Next Round' }}
              </button>

              <button *ngIf="gameStatus.game_active" class="btn btn-end" (click)="endGame()"
                [disabled]="isGameLoading">
                {{ isGameLoading ? 'Ending...' : 'End Game' }}
              </button>

              <span *ngIf="gameStatus.game_active && gameStatus.current_round >= gameStatus.total_rounds"
                class="game-finished">
                üèÅ Game Completed
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Board Details Section -->
      <div class="boards-section">
        <div class="content-card">
          <h3>üìä Board Status - {{ userInfo.group_id || 'group1' }}</h3>

          <div *ngIf="gameStatus?.statistics && gameStatus.statistics.length > 0; else noBoardsTemplate">
            <div class="boards-grid">
              <div class="board-card" *ngFor="let board of gameStatus.statistics">
                <div class="board-header">
                  <h4>{{ board.board_name || 'Board #' + board.board_id }}</h4>
                  <span class="board-type">{{ board.board_type }}</span>
                </div>

                <div class="board-stats">
                  <div class="stat">
                    <span class="stat-label">ID:</span>
                    <span class="stat-value">{{ board.board_id }}</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Generation:</span>
                    <span class="stat-value energy-positive">{{ (board.current_generation || 0).toFixed(2) }} kW</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Consumption:</span>
                    <span class="stat-value energy-negative">{{ (board.current_consumption || 0).toFixed(2) }} kW</span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Net Power:</span>
                    <span class="stat-value"
                      [class.energy-positive]="(board.current_generation || 0) - (board.current_consumption || 0) > 0"
                      [class.energy-negative]="(board.current_generation || 0) - (board.current_consumption || 0) < 0">
                      {{ ((board.current_generation || 0) - (board.current_consumption || 0)).toFixed(2) }} kW
                    </span>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Total Score:</span>
                    <span class="stat-value score">{{ board.total_score || 0 }}</span>
                  </div>
                  <div class="stat" *ngIf="board.last_update">
                    <span class="stat-label">Last Update:</span>
                    <span class="stat-value">{{ board.last_update | date:'medium' }}</span>
                  </div>
                </div>

                <!-- Power Plants & Consumers -->
                <div class="board-connections" *ngIf="board.connected_power_plants || board.connected_consumers">
                  <div class="connections-section" *ngIf="board.connected_power_plants?.length > 0">
                    <h5>‚ö° Power Plants</h5>
                    <div class="connection-list">
                      <span *ngFor="let plant of board.connected_power_plants" class="connection-item">
                        Type {{ plant.type }} ({{ plant.power }}W)
                      </span>
                    </div>
                  </div>
                  <div class="connections-section" *ngIf="board.connected_consumers?.length > 0">
                    <h5>üè† Consumers</h5>
                    <div class="connection-list">
                      <span *ngFor="let consumer of board.connected_consumers" class="connection-item">
                        Type {{ consumer.type }} ({{ consumer.consumption }}W)
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noBoardsTemplate>
            <div class="no-boards">
              <p>No boards registered yet in {{ userInfo.group_id || 'group1' }}. Boards will appear here when they register and start sending data.</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Board-only sections -->
    <div *ngIf="userInfo.user_type === 'board'" class="board-info">
      <div class="content-card">
        <h3>üîå Board Information</h3>
        <p><strong>Board Name:</strong> {{ userInfo.name }}</p>
        <p><strong>Group:</strong> {{ userInfo.group_id }}</p>
        <p><strong>Board Type:</strong> {{ userInfo.metadata?.board_type || 'Generic' }}</p>
        <p><strong>Location:</strong> {{ userInfo.metadata?.location || 'Unknown' }}</p>
        
        <div class="board-status-info">
          <p>This board is registered and ready to participate in energy management games.</p>
          <p>Game control is managed by your group's lecturer.</p>
        </div>
      </div>
    </div>

    <!-- Building Management Section -->
    <div class="building-management-section">
      <div class="content-card">
        <h3>üè¢ Building Power Consumption Management</h3>

        <div class="building-table-info">
          <p><strong>Current Table Version:</strong> {{ buildingTable?.version || 'Loading...' }}</p>
          <p>Manage power consumption values for different building types. Changes will be automatically distributed to
            all ESP boards.</p>
        </div>

        <div *ngIf="buildingTable?.table" class="building-table">
          <div class="table-header">
            <span>Building Type</span>
            <span>Power Consumption (W)</span>
            <span>Actions</span>
          </div>

          <div *ngFor="let entry of getBuildingTableEntries()" class="table-row">
            <span class="building-type">{{ getBuildingTypeName(entry.type) }}</span>
            <div class="consumption-control">
              <input #slider type="range" min="0" max="10000" step="5" class="consumption-slider"
                [value]="entry.consumption" [disabled]="isSavingBuildingTable"
                (input)="updateBuildingConsumption(entry.type, slider.valueAsNumber)">

              <input #field type="number" min="0" max="10000" step="1" class="consumption-input-small"
                [value]="entry.consumption" [disabled]="isSavingBuildingTable"
                (input)="updateBuildingConsumption(entry.type, field.valueAsNumber)">

              <span class="unit">W</span>
            </div>

            <button *ngIf="!isDefaultBuildingType(entry.type)" class="btn btn-delete-small"
              (click)="removeBuildingType(entry.type)" [disabled]="isSavingBuildingTable">
              Remove
            </button>
            <span *ngIf="isDefaultBuildingType(entry.type)" class="default-type">Default</span>
          </div>

          <div class="add-building-row">
            <select [(ngModel)]="newBuildingType" class="building-type-select">
              <option value="">Select Building Type</option>
              <option *ngFor="let type of getAvailableBuildingTypes()" [value]="type">
                {{ getBuildingTypeName(type) }}
              </option>
            </select>
            <div class="consumption-control">
              <input type="range" [(ngModel)]="newBuildingConsumption" class="consumption-slider" min="0" max="10000"
                step="5">
              <input type="number" [(ngModel)]="newBuildingConsumption" placeholder="Power (W)"
                class="consumption-input-small" min="0" max="10000" step="1">
              <span class="unit">W</span>
            </div>
            <button class="btn btn-add-small" (click)="addBuildingType()"
              [disabled]="!newBuildingType || !newBuildingConsumption || isSavingBuildingTable">
              Add
            </button>
          </div>
        </div>

        <div *ngIf="!buildingTable" class="loading-state">
          <p>Loading building table...</p>
        </div>

        <div *ngIf="buildingTable?.error" class="error-state">
          <p>Error loading building table: {{ buildingTable.error }}</p>
          <button class="btn btn-retry" (click)="loadBuildingTable()">Retry</button>
        </div>

        <div class="building-table-actions">
          <button class="btn btn-save" (click)="saveBuildingTable()"
            [disabled]="!isBuildingTableDirty || isSavingBuildingTable">
            {{ isSavingBuildingTable ? 'Saving...' : 'Save Changes' }}
          </button>
          <button class="btn btn-reset" (click)="resetBuildingTable()"
            [disabled]="!isBuildingTableDirty || isSavingBuildingTable">
            Reset Changes
          </button>
          <span *ngIf="buildingTableSaveStatus" [class]="buildingTableSaveStatus.type">
            {{ buildingTableSaveStatus.message }}
          </span>
        </div>
      </div>
    </div>

    <!-- Instructions Section -->
    <div class="instructions-section">
      <div class="content-card">
        <h3>üìö How to Use</h3>

        <div class="instructions">
          <div class="instruction-item">
            <h4>ÔøΩ Starting the Game</h4>
            <p>Click "Start Game" to begin the energy simulation. This will start round 1 and boards can begin reporting
              data.</p>
          </div>

          <div class="instruction-item">
            <h4>‚è≠Ô∏è Advancing Rounds</h4>
            <p>Use "Next Round" to advance to the next round. This calculates scores for the current round and moves the
              game forward.</p>
          </div>

          <div class="instruction-item">
            <h4>ÔøΩ Monitoring Boards</h4>
            <p>Watch real-time data from registered boards including power generation, consumption, and accumulated
              scores.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && !userInfo" class="error-state">
    <p>Unable to load user information. Please try logging in again.</p>
  </div>
</div>